# 非機能要件

**最終更新**: 2025-12-12
**バージョン**: 1.0

---

## 目次

1. [技術スタック](#1-技術スタック)
2. [入出力仕様](#2-入出力仕様)
3. [エラーハンドリング](#3-エラーハンドリング)
4. [セキュリティ](#4-セキュリティ)
5. [制約・前提条件](#5-制約前提条件)
6. [運用・保守](#6-運用保守)
7. [スコープ外（将来拡張）](#7-スコープ外将来拡張)

---

## 1. 技術スタック

### 1.1. 確定技術

| カテゴリ | 技術 | バージョン | 選定理由 |
|---------|------|-----------|----------|
| 言語 | Python | 3.11+ | スクレイピングライブラリが豊富、人間らしい操作が可能 |
| スクレイピング | Playwright | latest | 動的サイト対応、人間らしい振る舞いが可能、ヘッドレス/ヘッドフルモード切替 |
| AI/LLM | Gemini API | gemini-pro | ユーザー指定 |
| 設定管理 | PyYAML | latest | 可読性が高く編集しやすい |
| CLI | Typer | latest | モダンなCLI構築、型ヒント対応、自動ヘルプ生成 |
| HTTP | httpx | latest | 非同期対応、GitHub API用 |

### 1.2. 開発ツール

| カテゴリ | 技術 |
|---------|------|
| パッケージ管理 | pip / pyproject.toml |
| フォーマッター | black, isort |
| リンター | ruff |
| 型チェック | mypy |
| テスト | pytest |

---

## 2. 入出力仕様

### 2.1. 入力

#### CLI引数

| 引数 | 形式 | 必須 | 説明 |
|------|------|------|------|
| URL | string | Yes | 案件URL（ランサーズ or クラウドワークス） |

#### URL形式

| サービス | パターン | 例 |
|----------|---------|-----|
| ランサーズ | `https://www.lancers.jp/work/detail/{id}` | `https://www.lancers.jp/work/detail/12345` |
| クラウドワークス | `https://crowdworks.jp/public/jobs/{id}` | `https://crowdworks.jp/public/jobs/67890` |

#### URL判定ロジック

```python
# ドメインで判定
if "lancers.jp" in url:
    service = "lancers"
elif "crowdworks.jp" in url:
    service = "crowdworks"
else:
    raise InvalidURLError("対応していないサービスです")
```

### 2.2. 出力

#### 出力先

| オプション | 出力先 | デフォルト |
|-----------|--------|-----------|
| なし | 標準出力（stdout） | Yes |
| `--output file.txt` | 指定ファイル | No |
| `--copy` | クリップボード | No |

#### 出力形式

- プレーンテキスト（UTF-8）
- 改行コード: LF

#### 文字数制限

| サービス | 提案文字数上限 | 対応方針 |
|----------|---------------|----------|
| ランサーズ | 2,000文字 | 上限内に収める |
| クラウドワークス | 2,000文字 | 上限内に収める |

---

## 3. エラーハンドリング

### 3.1. エラー分類

| カテゴリ | エラー種別 | 対応方針 |
|---------|-----------|----------|
| 入力エラー | 無効なURL | エラーメッセージを表示して終了 |
| 入力エラー | 未対応サービス | エラーメッセージを表示して終了 |
| 通信エラー | スクレイピング失敗 | リトライ後、失敗ならエラー終了 |
| 通信エラー | GitHub API失敗 | GitHub情報なしで続行（警告表示） |
| 通信エラー | Gemini API失敗 | リトライ後、失敗ならエラー終了 |
| 設定エラー | 設定ファイル不正 | エラー箇所を表示して終了 |
| 設定エラー | APIキー未設定 | 設定方法を案内して終了 |

### 3.2. リトライ設定

| 対象 | リトライ回数 | リトライ間隔 |
|------|-------------|-------------|
| スクレイピング | 3回 | 5秒 |
| GitHub API | 2回 | 1秒 |
| Gemini API | 3回 | 2秒（指数バックオフ） |

### 3.3. エラーメッセージ例

```
# 無効なURL
Error: 無効なURLです。ランサーズまたはクラウドワークスの案件URLを指定してください。
例: proposal-gen https://www.lancers.jp/work/detail/12345

# APIキー未設定
Error: Gemini APIキーが設定されていません。
以下のいずれかの方法で設定してください:
1. 環境変数: export GEMINI_API_KEY=your_api_key
2. 設定ファイル: ~/.proposal-gen/settings.yaml に api_key を追加

# スクレイピング失敗
Error: 案件情報の取得に失敗しました。
原因: ページが見つかりません（404）
案件URLが正しいか、案件が公開されているか確認してください。
```

---

## 4. セキュリティ

### 4.1. 認証情報の管理

| 情報 | 保管方法 | 優先順位 |
|------|----------|---------|
| Gemini APIキー | 環境変数 `GEMINI_API_KEY` | 1 |
| Gemini APIキー | `~/.proposal-gen/settings.yaml` | 2 |
| GitHubトークン（オプション） | 環境変数 `GITHUB_TOKEN` | 1 |

### 4.2. セキュリティ要件

| ID | 要件 |
|----|------|
| NF-SEC-01 | APIキーを標準出力やログに出力しないこと |
| NF-SEC-02 | 設定ファイルのパーミッションは600を推奨すること |
| NF-SEC-03 | 環境変数からの読み込みを設定ファイルより優先すること |
| NF-SEC-04 | `.env.example` を提供し、実際のキーをコミットしないこと |

### 4.3. .env.example

```env
# Gemini API Key (Required)
GEMINI_API_KEY=your_api_key_here

# GitHub Token (Optional - for higher rate limit)
GITHUB_TOKEN=your_github_token_here
```

---

## 5. 制約・前提条件

### 5.1. 動作環境

| 項目 | 要件 |
|------|------|
| OS | macOS, Linux, Windows |
| Python | 3.11以上 |
| ブラウザ | Chromium（Playwrightが自動インストール） |
| ネットワーク | インターネット接続必須 |

### 5.2. 外部サービス依存

| サービス | 依存度 | 制限 |
|----------|--------|------|
| ランサーズ | 必須 | 利用規約に準拠（過度なアクセス禁止） |
| クラウドワークス | 必須 | 利用規約に準拠（過度なアクセス禁止） |
| Gemini API | 必須 | レート制限あり、APIキー必要 |
| GitHub API | オプション | 認証なし: 60 req/h、認証あり: 5,000 req/h |

### 5.3. スクレイピングに関する制約

| ID | 制約 |
|----|------|
| NF-CON-01 | ログインが必要な案件には対応しない |
| NF-CON-02 | 連続リクエストは最低5秒間隔を空ける |
| NF-CON-03 | User-Agentは一般的なブラウザを模倣する |
| NF-CON-04 | robots.txtを尊重する |

### 5.4. 免責事項

- 本ツールの使用は利用者の責任において行うこと
- 各サービスの利用規約を遵守すること
- スクレイピングによるサービス障害等には責任を負わない

---

## 6. 運用・保守

### 6.1. ログ

| レベル | 出力条件 | 内容 |
|--------|---------|------|
| ERROR | 常時 | エラー発生時 |
| WARNING | 常時 | 警告（GitHub情報取得失敗等） |
| INFO | `--verbose` | 処理の進捗 |
| DEBUG | `--verbose` | 詳細なデバッグ情報 |

### 6.2. ログ出力先

| 出力先 | 条件 |
|--------|------|
| 標準エラー出力（stderr） | 常時 |
| ファイル（`~/.proposal-gen/logs/`） | オプション |

### 6.3. 履歴管理

| 項目 | 対応 |
|------|------|
| 生成履歴の保存 | スコープ外（v1.0では対応しない） |
| 案件情報のキャッシュ | スコープ外（v1.0では対応しない） |

---

## 7. スコープ外（将来拡張）

以下の機能は v1.0 では対応しない。将来の拡張として検討。

| 機能 | 説明 |
|------|------|
| 他サービス対応 | ココナラ、シュフティ等の他クラウドソーシングサービス |
| 一括処理 | 複数URLを一度に処理 |
| Web UI | ブラウザからの操作 |
| ブラウザ拡張 | 案件ページ上で直接提案文を生成 |
| 履歴管理 | 過去の生成履歴を保存・検索 |
| 提案文のテンプレート学習 | 採用された提案文を学習して品質向上 |

---

## 関連ドキュメント

- [機能要件](./functional.md)
- [アーキテクチャ](../design/architecture.md)
- [設定仕様](../specs/config.md)
