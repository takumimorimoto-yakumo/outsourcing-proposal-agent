# プロンプト設計

**最終更新**: 2025-12-12
**バージョン**: 1.0

---

## 目次

1. [概要](#1-概要)
2. [プロンプト構造](#2-プロンプト構造)
3. [システムプロンプト](#3-システムプロンプト)
4. [ユーザープロンプト](#4-ユーザープロンプト)
5. [カテゴリ別追加指示](#5-カテゴリ別追加指示)
6. [出力制御](#6-出力制御)
7. [改善指針](#7-改善指針)

---

## 1. 概要

### 1.1. 目的

Gemini APIに送信するプロンプトを設計し、高品質な提案文を安定して生成する。

### 1.2. プロンプトの役割分担

| プロンプト種別 | 役割 | 変更頻度 |
|--------------|------|---------|
| システムプロンプト | AIの役割・制約を定義 | 低 |
| ユーザープロンプト | 具体的な案件情報・指示 | 毎回変動 |
| カテゴリ別追加指示 | カテゴリ固有の強調点 | 低 |

---

## 2. プロンプト構造

### 2.1. 全体構造

```
┌────────────────────────────────────────────┐
│           System Prompt                    │
│  - AIの役割定義                             │
│  - 出力形式の指定                           │
│  - 制約・禁止事項                           │
├────────────────────────────────────────────┤
│           User Prompt                      │
│  - 案件情報                                │
│  - GitHub情報                              │
│  - 固定文（自己紹介等）                     │
│  - カテゴリ別追加指示                       │
│  - 生成指示                                │
└────────────────────────────────────────────┘
```

### 2.2. トークン配分目安

| セクション | トークン目安 | 割合 |
|-----------|-------------|------|
| システムプロンプト | 500-800 | 20% |
| 案件情報 | 500-1000 | 30% |
| GitHub情報 | 300-500 | 15% |
| 固定文 | 300-500 | 15% |
| 生成指示 | 200-400 | 10% |
| **合計入力** | **1,800-3,200** | **100%** |
| **出力（提案文）** | **800-1,200** | - |

---

## 3. システムプロンプト

### 3.1. 基本構造

```python
SYSTEM_PROMPT = """
あなたはフリーランスエンジニア向けの提案文作成アシスタントです。
クラウドソーシングサービス（ランサーズ、クラウドワークス）で
高い採用率を獲得できる提案文を作成することが目標です。

## あなたの役割
- 案件情報を正確に理解し、クライアントの課題に共感する
- 具体的で実現可能な提案を行う
- エンジニアの技術力と実績を効果的にアピールする
- 自然で誠実な文章を作成する

## 提案文の構成（必須）
以下の6パートで構成してください：

1. **挨拶・自己紹介**: 提供された固定文をそのまま使用
2. **案件への理解・共感**: 案件の要点を自分の言葉で要約し、課題への共感を示す
3. **提案内容・アプローチ**: 具体的な実装方針、使用技術、工夫点を説明
4. **技術力・実績**: 関連する技術経験とGitHub実績を紹介
5. **スケジュール・見積もり**: 対応可能時期と稼働について
6. **締めの挨拶**: 提供された固定文をそのまま使用

## 制約事項
- 文字数は1,500〜1,800文字を目標とする（最大2,000文字）
- 虚偽の実績や経験を記載しない
- 過度な自慢や競合批判をしない
- 定型文の羅列を避け、案件固有の内容を含める
- 価格のダンピング表現を避ける
- 敬語を適切に使用し、自然な日本語で記述する

## 出力形式
- プレーンテキストで出力
- パート間は空行で区切る
- 箇条書きは適度に使用（多用しない）
"""
```

### 3.2. システムプロンプトの設計意図

| 要素 | 意図 |
|------|------|
| 役割定義 | AIの目標を明確化し、一貫した出力を促す |
| 構成指定 | 6パート構成を強制し、抜け漏れを防ぐ |
| 制約事項 | 不適切な出力を防止 |
| 出力形式 | 後処理しやすい形式を指定 |

---

## 4. ユーザープロンプト

### 4.1. 基本構造

```python
def build_user_prompt(
    job_info: JobInfo,
    github_data: GitHubData | None,
    profile: ProfileConfig,
    category_template: CategoryTemplate,
) -> str:
    return f"""
## 案件情報

**タイトル**: {job_info.title}

**カテゴリ**: {job_info.category}

**予算**: {format_budget(job_info)}

**納期**: {job_info.deadline or "記載なし"}

**必要スキル**: {", ".join(job_info.required_skills)}

**案件詳細**:
{job_info.description}

---

## 技術力・実績（GitHub情報）

{format_github_data(github_data)}

---

## 使用する固定文

**【挨拶・自己紹介】（Part 1 でそのまま使用）**
{profile.introduction.greeting}
{profile.introduction.self_intro}

**【締めの挨拶】（Part 6 でそのまま使用）**
{profile.closing.contact}
{profile.closing.farewell}

---

## カテゴリ別の強調ポイント

{category_template.strength}

アプローチのヒント:
{format_approach_hints(category_template.approach_hints)}

---

## 生成指示

上記の情報をもとに、提案文を作成してください。

- Part 1 と Part 6 は固定文をそのまま使用してください
- Part 2〜5 は案件情報とGitHub情報を活用して作成してください
- 案件の「{job_info.title}」に対する具体的な提案を含めてください
- 必要スキル「{", ".join(job_info.required_skills[:3])}」に関連する経験を強調してください
"""
```

### 4.2. GitHub情報のフォーマット

```python
def format_github_data(github_data: GitHubData | None) -> str:
    if github_data is None:
        return "（GitHub情報なし）"

    lines = []

    # プロフィール
    lines.append(f"**ユーザー名**: {github_data.profile.username}")
    if github_data.profile.bio:
        lines.append(f"**自己紹介**: {github_data.profile.bio}")

    # 言語統計
    lines.append(f"**主要言語**: {', '.join(github_data.top_languages[:5])}")

    # 関連リポジトリ
    if github_data.matched_repos:
        lines.append("\n**関連リポジトリ**:")
        for repo in github_data.matched_repos[:3]:
            stars = f"★{repo.stars}" if repo.stars > 0 else ""
            lines.append(f"- [{repo.name}]({repo.url}) {stars}")
            if repo.description:
                lines.append(f"  {repo.description[:100]}")

    return "\n".join(lines)
```

### 4.3. 予算のフォーマット

```python
def format_budget(job_info: JobInfo) -> str:
    if job_info.budget_min and job_info.budget_max:
        return f"{job_info.budget_min:,}円 〜 {job_info.budget_max:,}円"
    elif job_info.budget_max:
        return f"〜 {job_info.budget_max:,}円"
    elif job_info.budget_min:
        return f"{job_info.budget_min:,}円 〜"
    else:
        return "要相談"
```

---

## 5. カテゴリ別追加指示

### 5.1. Web開発

```python
WEB_DEVELOPMENT_ADDITION = """
## Web開発案件向けの追加指示

以下のポイントを提案に含めることを検討してください：
- レスポンシブデザインへの対応方針
- SEO対策（構造化データ、メタタグ等）
- パフォーマンス最適化（Core Web Vitals）
- セキュリティ対策（XSS、CSRF等）
- 保守・運用を見据えた設計
"""
```

### 5.2. スクレイピング

```python
SCRAPING_ADDITION = """
## スクレイピング案件向けの追加指示

以下のポイントを提案に含めることを検討してください：
- データ品質の担保方法
- エラーハンドリングとリトライ機構
- robots.txtの遵守
- 適切なリクエスト間隔
- データ形式の正規化・クレンジング
- 継続的なメンテナンス対応
"""
```

### 5.3. 自動化

```python
AUTOMATION_ADDITION = """
## 自動化案件向けの追加指示

以下のポイントを提案に含めることを検討してください：
- 現状業務の分析・可視化
- 自動化による効果の定量化
- 段階的な導入計画
- エラー発生時のアラート・リカバリー
- ドキュメント整備
- 引き継ぎ・保守体制
"""
```

---

## 6. 出力制御

### 6.1. 文字数制御プロンプト

```python
LENGTH_CONTROL_PROMPT = """
## 文字数について

- 目標文字数: 1,500〜1,800文字
- 最大文字数: 2,000文字（これを超えないこと）
- 最小文字数: 1,300文字（これを下回らないこと）

各パートの目安:
- Part 1 (挨拶): 150-200文字
- Part 2 (理解): 200-300文字
- Part 3 (提案): 400-600文字
- Part 4 (実績): 300-400文字
- Part 5 (スケジュール): 150-200文字
- Part 6 (締め): 100-150文字
"""
```

### 6.2. 再生成時の追加指示

#### 文字数不足時

```python
RETRY_TOO_SHORT = """
前回の出力が短すぎました（{current_length}文字）。
以下を追加・詳細化してください：
- Part 3 の提案内容をより具体的に
- Part 4 の技術経験の詳細を追加
- 案件固有の課題への対応方針を追加

目標: 1,500文字以上
"""
```

#### 文字数超過時

```python
RETRY_TOO_LONG = """
前回の出力が長すぎました（{current_length}文字）。
以下を簡潔化してください：
- 冗長な表現を削除
- 箇条書きを活用して簡潔に
- 重複する内容を統合

目標: 2,000文字以内
"""
```

---

## 7. 改善指針

### 7.1. プロンプト改善のタイミング

| トリガー | 改善アクション |
|---------|---------------|
| 生成品質が低い | システムプロンプトの制約を強化 |
| 特定カテゴリで失敗が多い | カテゴリ別追加指示を詳細化 |
| 文字数が安定しない | 文字数制御プロンプトを調整 |
| 構成が崩れる | 構成指定を具体化 |

### 7.2. A/Bテスト項目

| 項目 | バリエーション例 |
|------|----------------|
| temperature | 0.5 / 0.7 / 0.9 |
| システムプロンプトの長さ | 簡潔版 / 詳細版 |
| 構成指定の方法 | 番号指定 / 見出し指定 |
| 制約の強さ | 緩い / 厳しい |

### 7.3. フィードバックループ

```
1. 生成された提案文の品質を評価
   ↓
2. 問題点を特定
   - 構成の崩れ
   - 文字数の逸脱
   - 案件との関連性不足
   - 不自然な表現
   ↓
3. プロンプトを修正
   ↓
4. 再評価
   ↓
5. 改善が確認できたら本番反映
```

---

## 関連ドキュメント

- [提案文生成仕様](../specs/generation.md)
- [設定仕様](../specs/config.md)
- [アーキテクチャ](./architecture.md)
